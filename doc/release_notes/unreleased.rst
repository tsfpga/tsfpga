Fixes

* Performance improvements, typing fixes, and internal refactoring as suggested by ``ruff`` linter.
